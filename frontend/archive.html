<!DOCTYPE html>
<html lang="en">
<head>
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta charset="utf-8">
    <title>Node SCADA</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link href="/css/bootstrap.css" rel="stylesheet">
    <link href="/css/datepicker.css" rel="stylesheet">
    <link href="/css/controlfrog.css" rel="stylesheet" media="screen">   
    <link href="/css/nv.d3.css" rel="stylesheet" media="screen">   
    <link href="/favicon.ico" rel="shortcut icon" type="image/x-icon" />
    
    <script src="/js/d3.v3.min.js" charset="utf-8"></script>
    
    
    <script src="/js/jquery-1.9.1.min.js"></script>    
    <script src="/js/moment.js"></script>    
    <script src="/js/bootstrap.js"></script>
    <script src="/js/bootstrap-datepicker.js"></script>
    <script src="/js/controlfrog-plugins.js"></script>
    <script src="/js/nv.d3.js"></script>
    
    <!--[if lt IE 9]>
        <script src="/js/respond.min.js"></script>
        <script src="/js/excanvas.min.js"></script>
    <![endif]-->
    
    <script>
        var themeColour = 'black';
        
        // Colour settings
        if(themeColour == 'white'){
            var metric = '#a9a9a9';
            var backColor = '#7d7d7d';
            var pointerColor = '#898989';     
            var pageBackgorund = '#fff';
            var pieTrack = metric;
            var pieBar = backColor;
            var gaugeTrackColor = metric;
            var gaugeBarColor = backColor;
            var gaugePointerColor = '#ccc';
            var pieSegColors = [metric,'#868686','#636363','#404040','#1d1d1d'];    
        }
        else {
            //default to black
            var backColor = '#4f4f4f';
            var metric = '#f2f2f2';    
            var pointerColor = '#898989'; 
            var pageBackgorund = '#2b2b2b';    
            var pieSegColors = [metric,'#c0c0c0','#8e8e8e','#5b5b5b','#292929'];
            var pieTrack = backColor;
            var pieBar = metric;
            var gaugeTrackColor = '#4f4f4f';
            var gaugeBarColor = '#898989';
            var gaugePointerColor = metric;
        }

        $(document).ready(function(){
            // Navigation 
            $('.cf-nav-toggle').click(function(e){

                if( $('.cf-nav').hasClass('cf-nav-state-min') ){
                    $('.cf-nav').removeClass('cf-nav-state-min').addClass('cf-nav-state-max');
                    $('.cf-container').addClass('cf-nav-state-max');
                }
                else{
                    $('.cf-nav').removeClass('cf-nav-state-max').addClass('cf-nav-state-min');        
                    $('.cf-container').removeClass('cf-nav-state-max');            
                }
                
                e.preventDefault();
            });
        }); // end doc ready
    </script>
</head>
<body class="black">
    <div class="cf-nav cf-nav-state-min">
        <a href="" class="cf-nav-toggle">
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
        </a>
        
        <ul>
            <li class="current cf-nav-shortcut">
                <a href="/">
                    <span class="cf-nav-min">1</span>
                    <span class="cf-nav-max">main</span>
                </a>
            </li>
            <li class="cf-nav-shortcut">
                <a href="/archive.html" class="current active">
                    <span class="cf-nav-min">2</span>
                    <span class="cf-nav-max">archive</span>
                </a>
            </li>
        </ul>
    </div>
    
    <div class="cf-container cf-nav-active">
        <div class="row">
            <div class="well">
                <div class="alert alert-error" id="alert">
                    <strong>Oh snap!</strong>
                </div>
                <table class="table">
                <thead>
                    <tr>
                        <th>Start date<a href="#" class="btn small" id="dp4" data-date-format="yyyy-mm-dd">Change</a></th>
                        <th>End date<a href="#" class="btn small" id="dp5" data-date-format="yyyy-mm-dd">Change</a></th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td id="startDate"></td>
                        <td id="endDate"></td>
                    </tr>
                </tbody>
                </table>
            </div>
        </div>
        <div class="row">
            <style>
            #chart {
                background-color: #FFF;
            }
            #chart svg {
                height: 600px;
            }
            </style>

            <div id="chart">
              <svg></svg>
            </div>
        </div> <!-- //end row -->
    </div> <!-- //end container -->
    
    
    
     <script>
        $(function(){
            var startDate = new Date();
            var endDate = new Date();
            $('#dp4').datepicker()
                .on('changeDate', function(ev){
                    if (ev.date.valueOf() > endDate.valueOf()){
                        $('#alert').show().find('strong').text('The start date can not be greater then the end date');
                    } else {
                        $('#alert').hide();
                        startDate = new Date(ev.date);
                        $('#startDate').text($('#dp4').data('date'));
                        load();
                    }
                    $('#dp4').datepicker('hide');
                });
            $('#dp5').datepicker()
                .on('changeDate', function(ev){
                    if (ev.date.valueOf() < startDate.valueOf()){
                        $('#alert').show().find('strong').text('The end date can not be less then the start date');
                    } else {
                        $('#alert').hide();
                        endDate = new Date(ev.date);
                        $('#endDate').text($('#dp5').data('date'));
                        load();
                    }
                    $('#dp5').datepicker('hide');
                });
        
        
            window.chartData = [
                {
                    values: [], //values - represents the array of {x,y} data points
                    key: 'ТРМ t1', //key - the name of the series.
                }
            ];
            
            var chart;
            var format;
            function redraw(period) {
                nv.addGraph(function () {
                    chart = nv.models.lineWithFocusChart();
                            //.useInteractiveGuideline(true)
                            //.transition().duration(500);
                    
                    switch(period) {
                        case 'minute':
                            format = '%Y-%m-%d %H:%M';
                        break;
                        case 'hour':
                            format = '%Y-%m-%d %H:00';
                        break;
                        case 'day':
                            format = '%Y-%m-%d';
                        break;
                    }
    
                    chart.xAxis
                       .axisLabel('Date')
                       .rotateLabels(-20)
                       .tickFormat(function(d) { return d3.time.format(format)(new Date(d)); });

                    chart.yAxis
                        .tickFormat(d3.format(',.2f'));

                    d3.select('#chart svg')
                        .datum(window.chartData)
                        .transition()
                        .duration(500)
                        .call(chart);

                    nv.utils.windowResize(chart.update);

                    return chart;
                });        
            }
            
            function load() {
                var dateBegin = $('#dp4').data('date');
                var dateEnd = $('#dp5').data('date');
                console.log('load', dateBegin, dateEnd, window.location.host);
                if(dateBegin !='' && dateEnd != '') {
                    window.chartData[0].values = [];
                
                    $.ajax({
                        type: 'POST',
                        dataType: 'jsonp',
                        url: 'http://'+window.location.hostname+':8082/',
                        data: {
                            'date-begin': dateBegin,
                            'date-end': dateEnd
                        }
                    })
                    .error(function(res) {
                        console.log(res);
                    })
                    .done(function(res) {
                        //console.log(res);
                        var i = 0;
                        var c = res.length
                        var data;
                        for(;i<c;i++) {
                            data = res[i];
                            //console.log(data.date, moment(data.date, 'YYYY-MM-DD hh:mm:ss').format('YYYY-MM-DD hh:mm:ss'), data.value);
                            window.chartData[0].values.push({
                                x: moment(data.date, 'YYYY-MM-DD hh:mm:ss').valueOf(),
                                y: parseFloat(data.value)
                            });
                        }
                        redraw(data.period);
                    });
                }
                
                //window.chartData[0].values = [];
                //window.chartData[0].values.push({x: data.time, y: parseFloat(data.value)});
                //redraw();
            }
            /*
            $('#dp4').data('date', );
            $('#startDate').text($('#dp4').data('date'));
                var dateEnd = $('#dp5').data('date');
            
            load();*/
   
        }); // end doc ready
    </script>
</body>
</html>